# Grezwanderer 4 — Журнал обновлений (Changelog)

Все значимые изменения и этапы разработки проекта фиксируются здесь.

---

## [29.01.2026] — "The Open City" & Narrative Polish

### Добавлено
- **Case 1 Complete Implementation**: Полностью завершена сценарная ветка "Bankhaus Krebs".
    - **Interludes**: Реализованы промежуточные сцены A (Victoria Street Event) и B (Lotte Phone Call) с полной озвученной (текстово) драмой.
    - **Hybrid Finale**: Финал с двумя радикально разными ветками: "Political Provocation" (разоблачение коррупции) и "Syndicate War" (перестрелка).
    - **Personal Quest**: Внедрен квест Виктории "The Golden Cage" (сопровождение в паб), открывающийся через интерлюдию.
- **Audio System**:
    - **SoundManager**: Процедурный генератор звука на Web Audio API.
    - **Typewriter FX**: Каждый символ в диалоге теперь издает уникальный механический щелчок (без внешних mp3 файлов).
    - **Ambient Support**: Плавный кроссфейд фоновой музыки при смене сцен.
- **Interactive Feedback**:
    - **Toast Notifications**: Стильные уведомления (Art Deco) при сборе улик и добавлении заметок.
    - **Animated Tokens**: Улики и инсайты теперь пульсируют при наведении и анимированы (Framer Motion).
- **Aesthetic Overhaul (Detective's Desk)**:
    - **Color Palette**: Переход на теплую схему "Warm Black / Gold / Amber" (#d4c5a3, #1c1917, #b45309).
    - **Typography**: Интеграция шрифтов **Playfair Display** (Dialogue/Headers) и **Courier Prime** (Clues/Reports).

### Изменено
- **Logic<>Gameplay Sync**: Сбор улик в тексте (`[[id|text]]`) теперь автоматически устанавливает игровые флаги, открывая новые ветки диалогов.
- **Registry Update**: Все новые сценарии (Interludes, Finale, Quests) зарегистрированы и привязаны к точкам карты.

### Технические детали
- **Type Definitions**: Обновлены типы `VNScenario` для поддержки `musicUrl`.
- **Refactoring**: Очистка `VisualNovelOverlay` от хардкодных цветов в пользу CSS-переменных темы.

---

## [28.01.2026] — Hybrid Quest System & Developer Tools

### Добавлено
- **Hybrid Quest Engine**: Реализована гибридная система квестов, сочетающая линейные акты (Acts/Cases) с нелинейным графом расследования.
    - **Schema**: Добавлены таблицы `quests` и `user_quests`.
    - **QuestStore**: Клиентское управление состоянием квестов и целей.
    - **QuestLog Interface**: Новый оверлей-виджет (справа сверху) для отображения активных целей.
    - **Engine Hook**: `useQuestEngine` автоматически отслеживает флаги в `DossierStore` и обновляет прогресс квестов.
- **Developer Dashboard 2.0**: Значительное расширение функционала `/developer`.
    - **Quests Tab**: Просмотр реестра квестов, состояния игрока, принудительный запуск и завершение квестов.
    - **Interactive Debuggers**:
        - **Flags Manager**: Добавление кастомных флагов, переключение (toggle) значений и удаление.
        - **Stats Editor**: Полный контроль над 18 голосами (Parliament) через +/- кнопки.
        - **Traits Manager**: Добавление перков вручную.
    - **System Actions**: Кнопки для выдачи опыта и полного сброса прогресса (Factory Reset).
    - **Visualization**: Визуализация текущего XP навыков и доступных Dev Points.
- **Quest System Improvements**:
    - **Quest Reset**: Добавлена кнопка "Reset Quests" в панели разработчика для точечного сброса квестов без удаления всего прогресса.
    - **Bug Fixes**: Восстановлена целостность `DossierStore` и исправлены синтаксические ошибки в сборке.
- **Hybrid Progression System (v2.0)**:
    - **Usage-Based Logic**: Каждая проверка навыка (Logic, Empathy и т.д.) дает XP этому навыку.
        - Успех: +20 XP.
        - Провал: +10 XP (Learning from failure).
    - **Classic Leveling**: Общий XP персонажа (за квесты) повышает "Character Rank".
    - **Development Points**: Каждый уровень ранга дает 1 Dev Point для ручного повышения любого навыка.
    - **Character Page**: Полностью обновлен UI. Добавлены прогресс-бары навыков, отображение ранга и интерфейс траты очков.
- **Progression System**:
    - В `DossierStore` добавлены `xp`, `level` и `traits`.
    - Реализована логика `grantXp` с простым левелингом (1 уровень за 1000 XP).

### Изменено
- **UI Integration**: `App.tsx` теперь включает `QuestLog` и инициализирует `QuestEngine`.
- **Refactoring**: Очистка неиспользуемых импортов в сторах.

---

## [28.01.2026] — Database Migration (Map Points v2)

### Добавлено
- **Schema Extension**: В таблицу `map_points` добавлены поля `description`, `category` (канонические типы: `CRIME_SCENE | NPC | QUEST | EVENT | ACTIVITY | INTEREST | TRAVEL`), `image` (прямой путь к ассету).
- **Seed Script v2**: Обновлён `seed-map.ts` для вставки изображений как отдельного поля (не JSON).
- **Category Mapping**: `DetectiveMapPin.tsx` поддерживает как новые канонические категории, так и legacy типы (обратная совместимость).

### Удалено
- **Legacy Points**: Удалён файл `packages/shared/data/points.ts` (хардкодные точки).
- **Feature Flag**: Удалён `ENABLE_LEGACY_MAP_POINTS` — данные теперь только из БД.
- **Hybrid Merge**: Из `useMapPoints.ts` удалена логика слияния legacy + server данных.

- **Client Code**: `useMapPoints.ts` сокращён с 85 до 40 строк (только API fetch).
- **Resolver**: `resolveAvailableInteractions` теперь корректно парсит `bindings` как JSON-строку из БД.

### Character Page & Parliament Refactor
- **Character Page**: Реализована страница персонажа (`/character`) в стиле Art Deco / "Detective's Desk".
    - Отображение 18 голосов, сгруппированных по 6 категориям (Intellect, Psyche, Social, Physical, Shadow, Spirit).
    - Визуализация уровня и опыта.
    - Биография и заглушка для портрета.
- **Parliament System**: Полный рефакторинг фронтенда под систему 18 голосов.
    - `DossierStore` теперь отслеживает статистику всех 18 навыков.
    - Обновлены типы в `parliament.ts` (re-export из `@repo/shared`).
    - Иконки: Сгенерированы 5 базовых иконок Art Deco для групп навыков.
- **Build Fixes**:
    - Исправлен `MapPointSchema` (добавлено поле `image`).
    - Устранены ошибки импорта модулей в `CaseCard` и `DetectiveMapPin`.

### Архитектура данных
| Домен | Источник | Статус |
|-------|----------|--------|
| Map Points | SQLite | ✅ Мигрировано |
| User Progress | SQLite | ✅ Мигрировано |
| Hardlinks | `hardlinks.ts` | ⏳ Фаза 2 |
| Cases | `cases.ts` | ⏳ Фаза 2 |
| Deductions | `deductions.ts` | ⏳ Фаза 2 |

> **План**: `hardlinks.ts`, `cases.ts`, `deductions.ts` мигрируют в БД при реализации Content Editor.

---

## [27.01.2026] — Localization 2.0 & Unified Navbar

### Добавлено
- **Localization Engine 2.0**: Архитектурное разделение логики сценария (`Logic`) и текстового контента (`Content`).
    - Поддержка нескольких языков: **English (EN)**, **Deutsch (DE)**, **Русский (RU)**.
    - Система `mergeScenario`: Динамическая сборка сцен с автоматическим фоллбэком на английский при отсутствии перевода.
    - Улучшенный токенизатор: Безопасный парсинг интерактивных ссылок `[[улика|текст]]` через посимвольный обход.
- **Premium Navbar (The Detective's Desk)**: Новая централизованная панель управления в нижней части экрана.
    - Дизайн: Стиль **Art Deco / Liquid Glass** с использованием золотой отделки (#CA8A04), текстур дерева и эффекта размытия.
    - **Integrated HUD**: В Navbar перенесены функции выбора активного расследования (Investigation) и переключения языка.
    - **Global Navigation**: Прямое управление видимостью Досье (Dossier) и навигация по разделам.
- **Dossier Visibility Control**: Добавлено состояние `isDossierOpen` в `DossierStore`, позволяющее управлять журналом из любой части системы.

### Изменено
- **Cleanup**: Удалены устаревшие плавающие компоненты `MapHUD` и `LocaleSelector`.
- **Imports Optimization**: Очищен `MapView.tsx` от неиспользуемых импортов и легаси-логики управления UI.
- **Parliament Registry**: В `parliament.ts` добавлены метаданные групп голосов (Rational, Emotional, Mystical) для корректного отображения уровней в Досье.

### Технические детали
- **i18n Schema**: Внедрена строгая типизация для языковых пакетов, гарантирующая наличие всех ключей для сценариев.
- **Z-Index Refactoring**: Пересмотрена иерархия слоев: Navbar (300) > Overlay (200) > Fullscreen (180) > Dossier (150) > Map.

---


## [27.01.2026] — Detective Notebook & Dual-Mode Engine

### Добавлено
- **Detective Notebook Mechanic**: Интерактивная система заметок. Специальный синтаксис `[[текст]]` (Заметка) и `[[id|текст]]` (Улика) в текстах новеллы позволяет игроку кликом сохранять данные в Досье.
- **Dual-Mode VN Engine**: Движок визуальной новеллы теперь поддерживает два режима отображения:
    - **Overlay**: Текстовое окно поверх карты (исследование локаций).
    - **Fullscreen**: Полноэкранный кинематографичный режим для важных сюжетных развязок (Finale).
- **Notebook Widget**: Новый UI-компонент (виджет) для быстрого доступа к собранным заметкам и уликам прямо из интерфейса карты.
- **Case #1 Content Complete**: Полностью реализованы сценарии Дела №1 "Bankhaus Krebs":
    - *Bank Scene*: Осмотр места преступления (Overlay).
    - *Lab Analysis*: Анализ улик в университете (Overlay).
    - *Finale*: Финальная дедукция и конфронтация (Fullscreen).

### Изменено
- **TypedText Parser**: Реализован компонент `TypedText` с эффектом печатной машинки и парсингом интерактивных токенов.
- **Strict Typing**: Внедрена строгая типизация для `VoiceId` (Internal Parliament) и сценариев в `registry.ts`.
- **Dossier Upgrade**: `DossierStore` теперь поддерживает дедупликацию заметок и строгую типизацию типов записей (`note` vs `clue`).

### Технические детали
- **Unit Tests**: Написаны тесты для парсера `TypedText` (Vitest/JSDOM).
- **Registry Pattern**: Все сценарии теперь регистрируются в централизованном `SCENARIO_REGISTRY` для удобства управления.

---

### Добавлено
- **Database Schema**: Таблицы `map_points` (хранение точек) и `user_map_point_states` (прогресс игрока) в SQLite.
- **Seeding Script**: Скрипт `seed-map.ts` для миграции хардкодных данных в БД.
- **MapPointCard**: Новый UI-компонент карточки точки с поддержкой множественных действий (Actions).
- **ThreadLayer 2.0**: Слой нитей теперь полностью управляется данными (data-driven), реагирует на отфильтрованный список точек.

### Изменено
- **Refactoring**: Полное удаление легаси-кода `DETECTIVE_POINTS` из клиентской части.
- **Cleanup**: Удален флаг `ENABLE_LEGACY_MAP_POINTS` и гибридная логика слияния.
- **Performance**: Оптимизация рендеринга слоев карты (убраны лишние проверки состояний).

### Технические детали
- **Validation**: Zod-схемы для JSON-биндингов (Triggers, Conditions, Actions) гарантируют целостность данных в БД.
- **Idempotency**: API активации точек проверяет текущее состояние во избежание повторных срабатываний.

---

## [27.01.2026] — RPG Mechanics & Skill Checks

### Добавлено
- **Dice Logic Core**: Реализована утилита `dice.ts` для обработки проверок навыков (d20 roll + skill level vs Difficulty).
- **Store Upgrade**: `DossierStore` теперь хранит `voiceStats` (уровни навыков) и `checkStates` (история проверок: passed/failed/locked).
- **Skill Check Schema**: Расширен интерфейс `VNChoice` объектом `skillCheck`, определяющим сложность, тип голоса (Logic, Perception и т.д.) и последствия (onSuccess/onFail).
- **Interactive UI**: `VisualNovelOverlay` теперь визуализирует сложность проверок и обрабатывает броски кубиков, перенаправляя игрока по веткам успеха или провала.
- **Content Integration**: В сценарий Case #1 (Bank Vault) добавлены первые проверки (Logic: взлом замка, Perception: поиск улик) с уникальными текстовыми исходами.

### Технические детали
- **Shared Lib**: Логика кубиков вынесена в `packages/shared/lib/dice.ts` для переиспользования.
- **State Management**: Централизованное управление характеристиками через Zustand, без дублирования.
- **Schema Validation**: Строгая типизация всех исходов проверок (действия + навигация).

### Planning (Architecture)
- **MapPoint Engine 2.0**: Разработан детальный план (`docs/PLAN-map-point-types.md`) перехода на унифицированную систему точек.
  - **Single Source**: Отказ от разделения на hardcoded точки и динамические.
  - **Bindings DSL**: Внедрение системы "Триггер -> Условие -> Действие" (JSON-serializable).
  - **Lifecycle**: Четкие состояния `locked` -> `discovered` -> `visited` -> `completed`.

---

## [26.01.2026] — Фокус на Detective Mode

### Удалено
- **Survival Mode**: Полное удаление режима выживания и всех упоминаний о нём для фокусировки на детективном геймплее.
- **Инвентарь выживания**: Из `useInventoryStore` удалены поля и логика, специфичные для режима выживания.

### Изменено
- **Главная страница**: Редизайн с упором на единственную доступную кампанию "Freiburg 1905".
- **Сканер (Hardlinks)**: Теперь работает исключительно в детективном режиме, интерфейс стилизован под архивную тематику.
- **Карта**: Упрощена логика рендеринга, удалены проверки переключения режимов.

---

## [26.01.2026] — Стабилизация и визуальное обновление (Detective Mode)

### Добавлено
- **Унифицированный запуск**: Добавлен скрипт `bun run dev`, запускающий Web и Server параллельно.
- **Система Онбординга (Telegram)**: Тематическое введение в стиле телеграммы 1905 года для Detective Mode.
- **Фоновая загрузка карты**: Mapbox инициализируется в фоне под блюром во время онбординга.
- **Персистентность имени**: Inspector Name сохраняется в `useInventoryStore` (localStorage).
- **Архитектурная документация**: Создан `ARCHITECTURE.md` с описанием слоев FSD и механик.
- **Visual Novel Engine**: Легковесный движок (`entities/visual-novel`) с поддержкой выборов и действий.
- **Case #1 "Bankhaus Krebs"**: Реализован полный сюжетный цикл (5 сценариев: Briefing → Bank → Pub → Archive → Warehouse).
- **Интерактивные выборы**: Ответы в диалогах теперь открывают точки на карте и выдают улики.
- **Автоматизация (Plop.js + Husky)**: Генераторы для FSD и пре-коммит хуки для проверки кода.

### Исправлено
- **Контекстный UI Досье**: Компонент `Dossier` перенесен внутрь `MapView`.
- **Accessibility & UX**: Исправлены а11y-лейблы и увеличены области клика (Fitts' Law) в телеграмме.
- **Module Resolution**: Фикс импортов `react-map-gl/mapbox` и `verbatimModuleSyntax`.
- **Layout Logic**: Исправлена высота карты (`100%`) и навигация при отказе от дела.

### Технические детали
- Обновлен `useInventoryStore` (state: `playerName`).
- Валидация через `ux_audit.py`, `accessibility_checker.py` и `lint_runner.py`.



---
### Архитектурный план (Next Steps)
- **MapPoint Engine 2.0**: Переход на единую систему точек (MapPoint + Binding + Conditions DSL).
- **Navigation**: Интеграция реальной навигации по дорогам (Infrastructure-aware proxy).
- **Narrative Threads**: Визуализация связей между уликами на карте.
- **Server Authority**: Подготовка к полной синхронизации прогресса расследований.

---

## [26.01.2026] — Asset Suite & Visual Consistency

### Добавлено
- **Detective Asset Suite**: Набор из 11+ тематических ассетов в `public/images/detective` (архивные фото, маркеры-печати, штампы "Erledigt").
- **Circular Map Pins**: В `DetectiveMapPin.tsx` реализована логика отображения фото-локаций в круглых рамках с золотым свечением.
- **Generic Markers**: Система иконок для типов точек (Crime: Seal, Support: Anvil, Info: Inkblot).

### Изменено
- **Filename Normalization**: Все сгенерированные ассеты переименованы в чистый формат (без timestamp) для соответствия коду.
- **Tooltip Styling**: Тултипы меток на карте приведены к общему стилю (темный фон, Serif шрифт, увеличенный трекинг).

### Технические детали
- Реализован приоритет `point.image` над дефолтными иконками в `DetectiveMapPin`.
- Улучшена обработка состояний (unlocked/investigated/discovered) через CSS-фильтры (sepia/grayscale).


---

## [26.01.2026] — Внутренний Парламент (Internal Parliament)

### Добавлено
- **Система 18 голосов**: Реализована полная структура «Внутреннего парламента» (6 групп по 3 голоса) согласно `Обзор.md`.
- **Метаданные Голосов**: Создана база данных голосов (`parliament.ts`) с уникальными цветами, девизами и типами (Интеллект, Психика и др.).
- **Прогрессия навыков**: В `useInventoryStore` добавлена персистентная система уровней для каждого из 18 голосов.
- **Интерактивный Досье**: Новая вкладка **"Voices"** в компоненте `Dossier` для визуализации прокачки навыков сыщика.

### Изменено
- **Динамический CaseCard**: Теперь карточки на карте отображают комментарии от любых из 18 голосов, используя их тематические цвета.
- **Миграция данных**: Все существующие игровые точки переведены со старой системы (Rationalist/Romantic) на новые ID голосов (`logic`, `empathy`).

### Технические детали
- Добавлен `parliament.ts` в корень и в `features/detective/lib` для синхронизации логики.
- Исправлены ошибки типизации и отсутствующие зависимости (`zustand` в корне).
- Реализована динамическая фильтрация и рендеринг голосов в UI на основе метаданных.

---
---

## [26.01.2026] — Глубокое погружение и Технический долг

### Добавлено
- **Оперативное досье (Lore)**: Создан `Сюжет.md` — подробный стратегический анализ Фрайбурга 1905 года. Включает психогеографию районов (Шнекенфорштадт, Штюлингер), анализ банковского сектора и академическую экспертизу (тесты Уленгута, химия Килиани).
- **Сценарная интеграция**: Подготовка базы для «Сахариновой войны» и связей с контрабандой в Шварцвальде.

### Исправлено (Infrastructure)
- **ESLint Fix**: Исправлена конфигурация `lint-staged` для поддержки Flat Config в монорепозитории.
- **Type Safety**: Массовое удаление `any` в ключевых компонентах (`VisualNovelOverlay`, `CaseCard`, `MapView`) и переход на строгую типизацию `Evidence` и `MapAction`.
- **Pure Hooks**: Исправлены ошибки чистоты в `DetectiveMarker` (использование `Date.now()` в render и зависимости `useEffect`).
- **Commit Workflow**: Убран `tsc --noEmit` из `lint-staged` для ускорения коммитов и исправления конфликта флагов.

### Технические детали
- Обновлен корневой `package.json` (eslint paths).
- Все изменения успешно запушены в `master`.

---
---

## [26.01.2026] — Механика Дедукции и Криминалистика

### Добавлено
- **Deduction Board (Доска расследования)**: Новый UI-компонент в Досье, имитирующий рабочий стол детектива (пробковая доска). Позволяет визуально связывать улики нитями.
- **Deduction Engine**: Логика комбинации улик (`combineEvidence`). Поддержка рецептов: `Улика А + Улика Б = Результат` (открытие точки, флага или мини-игры).
- **Chemical Analysis (Мини-игра)**: Интерактивная модальная сцена «Лаборатория Килиани». Механика титрования (добавление капель реагента) для анализа веществ.
- **Assets**: Сгенерированы и интегрированы уникальные ассеты: фон доски, бутыль с реагентом, визуализация химической реакции.

### Технические детали
- **Zustand Store**: Расширен `DossierState` для хранения `unlockedDeductions`.
- **Optimization**: Ассеты оптимизированы и добавлены в `public/images/detective`.
- **Refactor**: Убраны циклические зависимости в `store.ts` через динамический импорт реестра дедукций.

---
*Следующий этап: Развитие системы навыков и интеграция Внутреннего Парламента в механики дедукции.*

